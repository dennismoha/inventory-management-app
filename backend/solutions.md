# solutions to some unfortunate situations that might occur.

- when you run `npx prisma migrate dev --name migration-name` and get this type of error
    ```
        Error: P3006

        Migration `20241110005322_initialize_db` failed to apply cleanly to the shadow database. 
        Error code: P1014
        Error:
        The underlying table for model `SupplierProducts` does not exist.
    ```

Then the solution is:

   1) Either delete  the whole migration table and re-run the whole migration afresh then run `npm run seed` to seed your db. This is because all the data will have been lost
   2) maybe you are running migration but creating some table violations. Get your problem from here. <a href="https://github.com/prisma/prisma/issues/13018">
Migration failed to apply cleanly to the shadow database </a>

### What is the shadow db ?
The "shadow database" in Prisma is a temporary database used during the migration process to help ensure that the migration is applied correctly and cleanly. Prisma uses this shadow database to validate and check the migration steps before applying them to the actual database.

### What is the role of the shadow database in Prisma migrations?

When you run a migration with Prisma, it performs the following steps:

1. **Schema Check**: Prisma compares the schema in your `schema.prisma` file to the current database schema to figure out what changes need to be made.
   
2. **Migration Simulation**: Before applying the migration to your actual database, Prisma creates a temporary "shadow database." This is a clean, empty database that has the same structure as your actual database, and Prisma uses it to apply the migration in a controlled environment.

3. **Validation**: Prisma applies the migration to the shadow database to ensure that it works as expected. If the migration fails on the shadow database, Prisma will not apply the migration to your actual database, preventing potential data corruption or errors.

### Why does the migration fail with the shadow database?

Here are some common reasons why a migration might fail with the shadow database:

1. **Incorrect Database URL**: If your `DATABASE_URL` or the shadow database URL is misconfigured, Prisma may not be able to create or connect to the shadow database. Ensure that the shadow database connection URL is valid in your `schema.prisma` file.
   
2. **Database Schema Issues**: If there is an issue with your Prisma schema or if it's incompatible with the database structure (e.g., trying to perform an invalid operation like renaming a column that has existing data), the migration will fail on the shadow database.

3. **Database Permissions**: If the database user used to connect to the shadow database doesn't have the required permissions (such as the ability to create, modify, or delete tables), Prisma might fail to apply the migration.

4. **Migration Conflicts**: If there are conflicts between the migration files or if a migration depends on changes that havenâ€™t been applied yet, it might fail when Prisma tries to apply them to the shadow database.

5. **Database Connection Issues**: If the shadow database is unreachable due to network issues, incorrect database credentials, or server problems, the migration might fail.

### How to fix it?

1. **Check the Shadow Database URL**: Verify that the connection string for the shadow database is correctly configured in your `schema.prisma` file. If you're using a specific environment for migrations, ensure the correct environment variables are set.
   
2. **Review Migration Files**: Look through your migration files to ensure there are no errors or conflicts. If necessary, manually review the SQL statements generated by Prisma.

3. **Revert or Reapply Migrations**: If the migration failed on the shadow database, you might want to try rolling back your migrations and running the migration again. You can use `prisma migrate reset` to clear and reset the database if needed.

4. **Check Database Permissions**: Ensure that the user connecting to the shadow database has appropriate permissions to perform schema changes.

5. **Try a Clean Migration**: You can also try resetting the migration state by deleting the `migrations` folder in your project and re-running `prisma migrate dev` to generate a fresh migration.


